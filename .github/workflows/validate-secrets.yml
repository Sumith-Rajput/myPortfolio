name: Validate Secrets Configuration

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check Required Secrets
        run: |
          echo "ğŸ” Validating GitHub Secrets Configuration..."
          echo ""
          
          missing_secrets=()
          
          # Check each secret via environment variables
          if [ -z "$AZURE_WEBAPP_NAME" ]; then
            echo "âŒ AZURE_WEBAPP_NAME is not set"
            missing_secrets+=("AZURE_WEBAPP_NAME")
          else
            echo "âœ… AZURE_WEBAPP_NAME is configured"
          fi
          
          if [ -z "$AZURE_RESOURCE_GROUP" ]; then
            echo "âŒ AZURE_RESOURCE_GROUP is not set"
            missing_secrets+=("AZURE_RESOURCE_GROUP")
          else
            echo "âœ… AZURE_RESOURCE_GROUP is configured"
          fi
          
          if [ -z "$AZURE_CREDENTIALS" ]; then
            echo "âŒ AZURE_CREDENTIALS is not set"
            missing_secrets+=("AZURE_CREDENTIALS")
          else
            echo "âœ… AZURE_CREDENTIALS is configured"
          fi
          
          if [ -z "$AZURE_STATIC_WEB_APPS_API_TOKEN" ]; then
            echo "âŒ AZURE_STATIC_WEB_APPS_API_TOKEN is not set"
            missing_secrets+=("AZURE_STATIC_WEB_APPS_API_TOKEN")
          else
            echo "âœ… AZURE_STATIC_WEB_APPS_API_TOKEN is configured"
          fi
          
          if [ -z "$VITE_API_URL" ]; then
            echo "âŒ VITE_API_URL is not set"
            missing_secrets+=("VITE_API_URL")
          else
            echo "âœ… VITE_API_URL is configured"
          fi
          
          if [ ${#missing_secrets[@]} -eq 0 ]; then
            echo ""
            echo "âœ… All required secrets are configured!"
            echo "ğŸš€ Your deployment workflows are ready to use."
          else
            echo ""
            echo "âš ï¸  Missing secrets: ${missing_secrets[*]}"
            echo "ğŸ“ Please add these secrets in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
        env:
          AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
          AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Validate Azure Credentials Format
        if: env.AZURE_CREDENTIALS != ''
        run: |
          echo "ğŸ” Validating AZURE_CREDENTIALS format..."
          # This is a basic check - credentials should be JSON
          if echo "$AZURE_CREDENTIALS" | jq empty 2>/dev/null; then
            echo "âœ… AZURE_CREDENTIALS format is valid JSON"
          else
            echo "âš ï¸  AZURE_CREDENTIALS might not be valid JSON"
            echo "   Expected format: {\"clientId\":\"...\",\"clientSecret\":\"...\",\"subscriptionId\":\"...\",\"tenantId\":\"...\"}"
          fi
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Display Configuration Summary
        run: |
          echo ""
          echo "ğŸ“‹ Configuration Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -z "$AZURE_WEBAPP_NAME" ]; then
            echo "Backend App Service: Not set"
          else
            echo "Backend App Service: $AZURE_WEBAPP_NAME"
          fi
          
          if [ -z "$AZURE_RESOURCE_GROUP" ]; then
            echo "Resource Group: Not set"
          else
            echo "Resource Group: $AZURE_RESOURCE_GROUP"
          fi
          
          if [ -z "$VITE_API_URL" ]; then
            echo "Frontend API URL: Not set"
          else
            echo "Frontend API URL: $VITE_API_URL"
          fi
          
          if [ -z "$AZURE_STATIC_WEB_APPS_API_TOKEN" ]; then
            echo "Static Web App Token: âŒ Not set"
          else
            echo "Static Web App Token: âœ… Set"
          fi
          
          if [ -z "$AZURE_CREDENTIALS" ]; then
            echo "Azure Credentials: âŒ Not set"
          else
            echo "Azure Credentials: âœ… Set"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ’¡ Next Steps:"
          echo "   1. If all secrets are set, you can trigger deployment"
          echo "   2. Push to main branch or run 'Deploy Portfolio App' workflow manually"
          echo "   3. Monitor deployment in Actions tab"
        env:
          AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

